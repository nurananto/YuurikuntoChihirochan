name: Encrypt New Manifest

on:
  push:
    branches:
      - main
    paths:
      - '**/manifest.json'
  
  workflow_dispatch:
    inputs:
      force_scan:
        description: 'Force scan all manifests (ignore git diff)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  encrypt-manifest:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for better git diff
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ” Detect and Encrypt manifests
        env:
          SECRET_TOKEN: ${{ secrets.MANIFEST_SECRET_TOKEN }}
          # Force scan if manual trigger with force_scan = true
          FORCE_SCAN_ALL: ${{ github.event.inputs.force_scan == 'true' || 'false' }}
        run: |
          echo "ğŸ” Encryption Mode: $FORCE_SCAN_ALL"
          node encrypt-manifest.js
      
      - name: ğŸ“ Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No new manifests encrypted"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Manifests encrypted!"
            git status --short
          fi
      
      - name: ğŸ’¾ Commit encrypted manifests
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add '**/manifest.json'
          
          # âœ… Hapus [skip ci] agar manga-automation bisa jalan
          git commit -m "ğŸ” Encrypt new manifest"
          git push origin main
          
          echo ""
          echo "âœ… Encrypted manifests pushed!"
          echo "â„¹ï¸  manga-automation.yml will run automatically"
          echo "   (triggered by this commit to manifest.json)"
